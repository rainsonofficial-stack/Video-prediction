<!DOCTYPE html>
<html>
<head>
    <title>Remote</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; background: #000; color: #444; font-family: sans-serif; touch-action: none; overflow: hidden; }
        .screen { display: none; height: 100vh; width: 100vw; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .active { display: flex; }
        .mode-btn { padding: 25px; width: 80%; margin: 10px; background: #111; color: #666; border: 1px solid #333; border-radius: 10px; font-size: 1.2rem; }
        
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 90%; }
        .num-btn { padding: 30px; background: #0a0a0a; border: 1px solid #222; color: #fff; font-size: 1.5rem; border-radius: 10px; }
        .send-btn { background: #fff !important; color: #000 !important; font-weight: bold; }
        
        #top-right-display { position: absolute; top: 15px; right: 15px; color: #555; font-size: 1.5rem; font-family: monospace; }
        .back-nav { position: absolute; top: 15px; left: 15px; padding: 10px; color: #444; border: 1px solid #222; border-radius: 5px; }
        
        #peek-container { 
            position: absolute; bottom: 40px; left: 20px; 
            display: none; flex-direction: column; pointer-events: none; 
            font-family: monospace; border-left: 2px solid #333; padding-left: 10px;
        }
        .peek-label { font-size: 0.7rem; color: #444; text-transform: uppercase; margin-bottom: -5px; }
        .peek-val { font-size: 1.8rem; margin-bottom: 10px; }
        #peek-last { color: #555; }
        #peek-current { color: #888; }
        
        .corner { position: absolute; width: 40%; height: 30%; z-index: 100; background: transparent; }
    </style>
</head>
<body>

    <div id="setup-screen" class="screen active">
        <h2 id="status">System Initializing...</h2>
        <button class="mode-btn" onclick="showScreen('button-screen')">Button Mode</button>
        <button class="mode-btn" onclick="showScreen('gesture-screen')">Swipe Mode</button>
    </div>

    <div id="button-screen" class="screen">
        <div id="top-right-display">_</div>
        <div class="back-nav" onclick="showScreen('setup-screen')">Back</div>
        <div style="color:#333; font-size: 3rem; margin-bottom: 20px;" id="btn-display">_</div>
        <div class="grid">
            <button class="num-btn" onclick="addDigit(7)">7</button><button class="num-btn" onclick="addDigit(8)">8</button><button class="num-btn" onclick="addDigit(9)">9</button>
            <button class="num-btn" onclick="addDigit(4)">4</button><button class="num-btn" onclick="addDigit(5)">5</button><button class="num-btn" onclick="addDigit(6)">6</button>
            <button class="num-btn" onclick="addDigit(1)">1</button><button class="num-btn" onclick="addDigit(2)">2</button><button class="num-btn" onclick="addDigit(3)">3</button>
            <button class="num-btn" onclick="clearInput()">C</button><button class="num-btn" onclick="addDigit(0)">0</button>
            <button class="num-btn send-btn" onclick="sendData()">SEND</button>
        </div>
    </div>

    <div id="gesture-screen" class="screen">
        <div class="corner" style="bottom:0; left:0" id="back-zone"></div>
        <div class="corner" style="bottom:0; right:0" id="peek-zone"></div>
        
        <div id="peek-container">
            <div class="peek-label">Last Sent</div>
            <div class="peek-val" id="peek-last">_</div>
            <div class="peek-label">Current</div>
            <div class="peek-val" id="peek-current">_</div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDxPQYrMlOslsqJeHnfj2MSpROZfaAwVH0",
            authDomain: "rainson-magic.firebaseapp.com",
            projectId: "rainson-magic",
            databaseURL: "https://rainson-magic-default-rtdb.firebaseio.com",
            storageBucket: "rainson-magic.firebasestorage.app",
            messagingSenderId: "290150598500",
            appId: "1:290150598500:web:4fbe7642b2baf839609c71"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentInput = "";
        let lastSentValue = "_";
        let swipePath = [];
        let holdTimer;

        // Fetch last value on load & keep it updated
        db.ref('currentVideo').on('value', (snapshot) => {
            const cloudVal = snapshot.val();
            if (cloudVal) {
                lastSentValue = cloudVal.replace("video", "");
            } else {
                lastSentValue = "_";
            }
            updateDisplays();
        });

        db.ref('.info/connected').on('value', snap => {
            document.getElementById('status').innerText = snap.val() ? "System Live" : "Connecting...";
        });

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function vibrate(ms) { if (navigator.vibrate) navigator.vibrate(ms); }

        function addDigit(d) {
            currentInput += d;
            updateDisplays();
            vibrate(50);
        }

        function updateDisplays() {
            document.getElementById('btn-display').innerText = currentInput || "_";
            document.getElementById('peek-current').innerText = currentInput || "_";
            document.getElementById('top-right-display').innerText = lastSentValue;
            document.getElementById('peek-last').innerText = lastSentValue;
        }

        function clearInput() {
            currentInput = "";
            swipePath = [];
            updateDisplays();
            vibrate([60, 40, 60]); 
        }

        function sendData() {
            if (currentInput === "") return;
            
            // 1. SEND TO CLOUD
            db.ref('currentVideo').set("video" + currentInput);
            db.ref('lastSentTime').set(Date.now());
            
            // 2. WIPE CURRENT INPUT IMMEDIATELY
            currentInput = ""; 
            swipePath = [];
            
            // 3. REFRESH VISUALS
            vibrate(400);
            updateDisplays(); 
        }

        let startX, startY;
        const gScreen = document.getElementById('gesture-screen');

        gScreen.addEventListener('touchstart', e => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            holdTimer = setTimeout(sendData, 2000); // Trigger send on 2s hold
        });

        gScreen.addEventListener('touchend', e => {
            clearTimeout(holdTimer);
            const dx = e.changedTouches[0].clientX - startX;
            const dy = e.changedTouches[0].clientY - startY;
            if (Math.sqrt(dx*dx + dy*dy) > 20) {
                let dir = Math.abs(dx) > Math.abs(dy) ? (dx > 0 ? "right" : "left") : (dy > 0 ? "down" : "up");
                swipePath.push(dir);
                if (swipePath.length === 2) {
                    const map = {"up,up":0,"up,right":1,"right,up":2,"right,right":3,"right,down":4,"down,right":5,"down,down":6,"down,left":7,"left,down":8,"left,left":9};
                    let d = map[swipePath.join(',')];
                    if (d !== undefined) addDigit(d);
                    swipePath = [];
                }
            }
        });

        function handleMultiTap(element, targetCount, callback) {
            let count = 0, timer;
            element.addEventListener('click', () => {
                count++;
                clearTimeout(timer);
                timer = setTimeout(() => {
                    if (count === targetCount) callback();
                    count = 0;
                }, 300);
            });
        }

        handleMultiTap(gScreen, 3, clearInput);
        handleMultiTap(document.getElementById('back-zone'), 2, () => showScreen('setup-screen'));
        handleMultiTap(document.getElementById('peek-zone'), 2, () => {
            const p = document.getElementById('peek-container');
            p.style.display = (p.style.display === 'flex') ? 'none' : 'flex';
            vibrate(30);
        });
    </script>
</body>
</html>
