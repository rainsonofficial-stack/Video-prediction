<!DOCTYPE html>
<html>
<head>
    <title>Remote</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #444; font-family: sans-serif; touch-action: none; }
        .screen { display: none; height: 100vh; width: 100vw; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }
        .mode-btn { padding: 25px; width: 80%; margin: 10px; background: #111; color: #666; border: 1px solid #333; border-radius: 10px; font-size: 1.2rem; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 90%; }
        .num-btn { padding: 30px; background: #0a0a0a; border: 1px solid #222; color: #fff; font-size: 1.5rem; border-radius: 10px; }
        #peek-display { position: absolute; bottom: 40px; left: 40px; color: #222; font-size: 2rem; display: none; }
        .corner { position: absolute; width: 25%; height: 20%; z-index: 100; }
    </style>
</head>
<body>

    <div id="setup-screen" class="screen active">
        <h2 id="status">Initializing...</h2>
        <button class="mode-btn" onclick="showScreen('button-screen')">Button Mode</button>
        <button class="mode-btn" onclick="showScreen('gesture-screen')">Swipe Mode</button>
    </div>

    <div id="button-screen" class="screen">
        <div style="color:#222; font-size: 2rem; margin-bottom: 20px;" id="btn-display">_</div>
        <div class="grid">
            <button class="num-btn" onclick="addDigit(7)">7</button><button class="num-btn" onclick="addDigit(8)">8</button><button class="num-btn" onclick="addDigit(9)">9</button>
            <button class="num-btn" onclick="addDigit(4)">4</button><button class="num-btn" onclick="addDigit(5)">5</button><button class="num-btn" onclick="addDigit(6)">6</button>
            <button class="num-btn" onclick="addDigit(1)">1</button><button class="num-btn" onclick="addDigit(2)">2</button><button class="num-btn" onclick="addDigit(3)">3</button>
            <button class="num-btn" onclick="clearInput()">C</button><button class="num-btn" onclick="addDigit(0)">0</button><button class="num-btn" onclick="sendData()" style="color:#0f0">SEND</button>
        </div>
    </div>

    <div id="gesture-screen" class="screen">
        <div class="corner" style="top:0; left:0" id="back-zone"></div>
        <div class="corner" style="bottom:0; right:0" id="peek-zone"></div>
        <div id="peek-display">_</div>
    </div>

    <script>
        const ROOM_ID = "magic-room-rainson";
        let peer = new Peer(ROOM_ID); // Fix the Remote ID
        let connections = [];
        let currentInput = "";
        let swipePath = [];

        peer.on('open', () => document.getElementById('status').innerText = "System Live");
        peer.on('connection', conn => {
            connections.push(conn);
            vibrate(100);
        });

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function vibrate(ms) { if (navigator.vibrate) navigator.vibrate(ms); }

        function addDigit(d) {
            currentInput += d;
            document.getElementById('btn-display').innerText = currentInput;
            document.getElementById('peek-display').innerText = currentInput;
            vibrate(50);
        }

        function clearInput() {
            currentInput = "";
            swipePath = [];
            document.getElementById('btn-display').innerText = "_";
            document.getElementById('peek-display').innerText = "_";
            vibrate([50, 50]);
        }

        function sendData() {
            const msg = "video" + currentInput;
            connections.forEach(c => { if(c.open) c.send(msg); });
            vibrate(400);
            currentInput = "";
            document.getElementById('btn-display').innerText = "_";
        }

        // --- FIXED GESTURE LOGIC ---
        let startX, startY, startTime;
        const gScreen = document.getElementById('gesture-screen');

        gScreen.addEventListener('touchstart', e => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            startTime = Date.now();
        });

        gScreen.addEventListener('touchend', e => {
            const dx = e.changedTouches[0].clientX - startX;
            const dy = e.changedTouches[0].clientY - startY;
            const duration = Date.now() - startTime;
            const dist = Math.sqrt(dx*dx + dy*dy);

            if (dist < 10 && duration > 2000) { sendData(); return; }

            if (dist > 20) { // Increased threshold slightly for stability
                let dir = Math.abs(dx) > Math.abs(dy) ? (dx > 0 ? "right" : "left") : (dy > 0 ? "down" : "up");
                swipePath.push(dir);
                if (swipePath.length === 2) {
                    const map = {"up,up":0,"up,right":1,"right,up":2,"right,right":3,"right,down":4,"down,right":5,"down,down":6,"down,left":7,"left,down":8,"left,left":9};
                    let d = map[swipePath.join(',')];
                    if (d !== undefined) addDigit(d);
                    swipePath = [];
                }
            }
        });

        // Corner Taps
        let backTaps = 0, peekTaps = 0;
        document.getElementById('back-zone').onclick = () => {
            backTaps++; setTimeout(() => { if(backTaps === 2) showScreen('setup-screen'); backTaps = 0; }, 300);
        };
        document.getElementById('peek-zone').onclick = () => {
            peekTaps++; setTimeout(() => { 
                if(peekTaps === 2) {
                    const p = document.getElementById('peek-display');
                    p.style.display = p.style.display === 'block' ? 'none' : 'block';
                }
                peekTaps = 0;
            }, 300);
        };
    </script>
</body>
</html>
